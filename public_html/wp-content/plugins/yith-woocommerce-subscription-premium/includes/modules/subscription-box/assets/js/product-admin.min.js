jQuery(function(n){!function(){this.stepsWrapper=n(".ywsbs-box-steps"),this.stepAddTrigger=n(".ywsbs-box-step-add"),this.stepTemplate=wp.template("ywsbs-box-step"),this.editorId="ywsbs_box_steps_text_editor",this.editorTemplate=wp.template("ywsbs-box-editor-field"),this.editorModal=null,this.init=()=>{n(document.body).on("woocommerce-product-type-change",this.panelVisibility),n(document.body).on("change",'select[name="_ywsbs_box_discount_type"]',this.toggleDiscountType),this.panelVisibility(),this.stepsWrapper.length&&(this.stepAddTrigger.on("click",this.addStep),n(document.body).on("click",".delete-step",this.stepDelete),n(document.body).on("ywsbs_box_step_added ywsbs_box_step_deleted",this.updateStepContentOption),n(document.body).on("change","#_ywsbs_box_steps_content_1",{handler:this},this.addStepVisibilityToggle),n(document.body).on("click",".edit-step",this.stepVisibilityToggle),n(document.body).on("click",".ywsbs_box_steps_text_editor_trigger",{handler:this},this.openTextareaEditor),n(document.body).on("click",".save-step-text",{handler:this},this.saveTextareaEditor),this.initSteps())},this.panelVisibility=()=>{var t=n('select[name="product-type"]').val(),e=n('input[name="_ywsbs_subscription"]'),i=n('input[name="_ywsbs_enable_trial"]');"ywsbs-subscription-box"===t?(e.prop("checked",!0).change(),i.removeAttr("checked").change(),i.closest(".ywsbs-product-metabox-field").hide()):i.closest(".ywsbs-product-metabox-field").show()},this.toggleDiscountType=function(t){var e=n(this),i=e.siblings('input[name="_ywsbs_box_discount_value"]');"percentage"===e.val()?i.removeClass("wc_input_price").attr({type:"number",min:"0",max:"100",step:"1"}):i.addClass("wc_input_price").attr("type","text").removeAttr("min").removeClass("max").removeAttr("step")},this.initSteps=()=>{var t,e,i=this.stepsWrapper.data("steps");if(_.isEmpty(i))return this.addStep(),!1;for([t,e]of Object.entries(i))e.id=t,"object"==typeof e&&this.addStep(e)},this.addStep=(t={})=>{t.index=this.getStepIndex(),t.id=t.id||t.index,this.stepAddTrigger.before(this.stepTemplate(t)),this.initStepFields(t.id),n(document.body).trigger("ywsbs_box_step_added")},this.getStepIndex=()=>this.stepsWrapper.children(".ywsbs-box-step").length+1,this.initStepFields=t=>{for(input of n(`.ywsbs-box-step[data-id="${t}"] :input`)){var e=n(input).data("value");if(e)if("checkbox"===n(input).attr("type"))"yes"===e?n(input).val("yes").attr("checked","checked"):n(input).removeAttr("checked");else if(n(input).hasClass("yith-post-search")||n(input).hasClass("yith-term-search"))for(var[i,s]of Object.entries(e))n(input).append(new Option(s,i,!0,!0));else n(input).val(e),"hidden"===input.type&&this.updateStepTextPreview(input.id,e);n(input).removeAttr("data-value").change()}jQuery(document).trigger("yith_fields_init").trigger("yith-plugin-fw-tips-init")},this.updateStepTextPreview=(t,e)=>{var i=n(`#${t}_preview`);if(!i.length)return!1;if(!i.hasClass("initialized")){i.contents().find("head").append('<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">');for(const s of tinyMCEPreInit.mceInit[this.editorId].content_css.split(","))i.contents().find("head").append('<link rel="stylesheet" type="text/css" href="'+s+'">');i.addClass("initialized")}i.contents().find("body").html(e)},this.openTextareaEditor=function(t){t.preventDefault();const e=t.data.handler,i=n(this).find("input");var t=i.closest("fieldset").find("legend").text(),s=i.closest("fieldset").find(".description").text();e.editorModal=yith.ui.modal({width:600,title:t+'<p class="description">'+s+"</p>",content:e.editorTemplate({}),footer:'<button class="yith-plugin-fw__button--primary yith-plugin-fw__button--xl save-step-text" data-target="'+i.attr("id")+'">'+ywsbsProductAdmin.buttonLabel+"</button>",classes:{wrap:"ywsbs-box-step-text-editor"},allowWpMenu:!1,onCreate:function(){var t;"undefined"!=typeof tinyMCE&&"undefined"!=typeof tinyMCEPreInit&&(n("#ywsbs_box_steps_text_editor").val(i.val()??"").change(),t=tinyMCEPreInit.mceInit[e.editorId],tinyMCE.init(t),tinyMCE.execCommand("mceRemoveEditor",!0,e.editorId),tinyMCE.execCommand("mceAddEditor",!0,e.editorId),t=tinyMCEPreInit.qtInit[e.editorId],quicktags(t),QTags._buttonsInit(),n("#ywsbs_box_steps_text_editor-html").click(),n("#ywsbs_box_steps_text_editor-tmce").click())},onClose:function(){e.editorModal=null}})},this.saveTextareaEditor=function(t){t.preventDefault();t=t.data.handler;if(null===t.editorModal)return!1;var e=n(this).data("target"),i=(n("#ywsbs_box_steps_text_editor-html").click(),n("textarea#ywsbs_box_steps_text_editor").val());n("input#"+e).val(i),t.updateStepTextPreview(e,i),t.editorModal.close()},this.stepVisibilityToggle=function(t){t.preventDefault(),t.stopImmediatePropagation(),n(this).closest(".ywsbs-box-step").toggleClass("opened").find(".ywsbs-step-settings").slideToggle()},this.updateStepContentOption=()=>{var t=n("select[id*=_ywsbs_box_steps_content]"),e=t.find("option[value=all_products]");1<t.length?e.attr("disabled","disabled").hide():e.removeAttr("disabled").show(),t.map((t,e)=>{var i;null===n(e).val()&&(i=n(e).find("option").filter(":not(:disabled)").first().attr("value"),n(e).val(i).change())})},this.addStepVisibilityToggle=function(t){"all_products"===n(this).val()?t.data.handler.stepAddTrigger.hide():t.data.handler.stepAddTrigger.show()},this.stepDelete=function(t){t.preventDefault(),t.stopImmediatePropagation(),n(this).closest(".ywsbs-box-step").fadeOut(400,function(){n(this).remove(),n(document.body).trigger("ywsbs_box_step_deleted")})},init()}()});